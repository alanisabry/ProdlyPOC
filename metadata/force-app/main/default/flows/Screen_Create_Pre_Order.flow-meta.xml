<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>51.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <description>Adds the order product to the list of order products in the sObject collection variable.</description>
        <name>Add_Order_Product_to_List</name>
        <label>Add Order Product to List</label>
        <locationX>323</locationX>
        <locationY>1923</locationY>
        <assignmentItems>
            <assignToReference>listPreOrderProducts</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>oMRROrderProduct</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_MRR_Oppty_Products</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_list_to_create</name>
        <label>Add to list to create</label>
        <locationX>991</locationX>
        <locationY>1794</locationY>
        <assignmentItems>
            <assignToReference>listOrderProductsToCreate</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>orPreOrderProduct</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_Upsell_OLI</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_list_to_delete</name>
        <label>Add to list to delete</label>
        <locationX>1408</locationX>
        <locationY>1786</locationY>
        <assignmentItems>
            <assignToReference>listPreOrderProductToDelete</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_Renewal_Products</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_counter</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_list_to_update</name>
        <label>Add to list to updarte</label>
        <locationX>1288</locationX>
        <locationY>1938</locationY>
        <assignmentItems>
            <assignToReference>listPreOrderProductsToUpdate</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_Renewal_Products</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_counter</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_new_Qtity</name>
        <label>Assign new Qtity</label>
        <locationX>1572</locationX>
        <locationY>1938</locationY>
        <assignmentItems>
            <assignToReference>Loop_Renewal_Products.Quantity</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>NewQuantity</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_list_to_update</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Uses the opportunity’s or account’s field values to assign field values to the order.

ACTION: Review the order fields assigned, and add/remove fields as needed.  

If you need fields from another object, use a Fast Lookup element to store the fields in another sObject variable before this element in the flow, and then assign the stored values to the order here.</description>
        <name>Assign_Order_Fields</name>
        <label>Assign Order Fields</label>
        <locationX>338</locationX>
        <locationY>1323</locationY>
        <assignmentItems>
            <assignToReference>oOrder.AccountId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOppty.AccountId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.EffectiveDate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOppty.Startdate_contract__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.Type</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Pre-Order</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.OpportunityId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOppty.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.Pricebook2Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOppty.Pricebook2Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.EndDate</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>contractStartDatePlusYear</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.PoNumber</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOppty.PO_Number__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.CurrencyIsoCode</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOppty.CurrencyIsoCode</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.Description</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Description</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.Status</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Draft</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.RecordTypeId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>RecordTypeID</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oOrder.Stop_auto_activation__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Create_Order</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Uses the opportunity product’s or order’s field values to assign field values to the order product.

ACTION: Review the order product fields assigned, and add/remove fields as needed.  

If you need fields from another object, use a Fast Lookup element to store the fields in another sObject variable before this element in the flow, and then assign the stored values to the order product here.</description>
        <name>Assign_Order_Product_Fields</name>
        <label>Assign Order Product Fields</label>
        <locationX>450</locationX>
        <locationY>1848</locationY>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.OrderId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOrder.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.PricebookEntryId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oMRROpptyProduct.PricebookEntryId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.Quantity</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oMRROpptyProduct.Quantity</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.TotalPrice</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oMRROpptyProduct.TotalPrice</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.Discount__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oMRROpptyProduct.Discount</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.Description</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Auto Generated</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.UnitPrice</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oMRROpptyProduct.UnitPrice</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.For_Contract_Renewals_mapped__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oMRROrderProduct.Part_of_a_package__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oMRROpptyProduct.Part_of_a_package__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Order_Product_to_List</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Pre_Order_Product</name>
        <label>Assign Pre-Order Product</label>
        <locationX>970</locationX>
        <locationY>1943</locationY>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.Quantity</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Upsell_OLI.Quantity</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.UnitPrice</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Upsell_OLI.UnitPrice</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.PricebookEntryId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Upsell_OLI.PricebookEntryId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.TotalPrice</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Upsell_OLI.TotalPrice</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.Discount__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Upsell_OLI.Discount</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.For_Contract_Renewals_mapped__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.Description</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Auto-generated Pre-order item</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.OrderId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>oOrder.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>orPreOrderProduct.Part_of_a_package__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_Upsell_OLI.Part_of_a_package__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_list_to_create</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Blank_update_counter</name>
        <label>Blank update counter</label>
        <locationX>1100</locationX>
        <locationY>1753</locationY>
        <assignmentItems>
            <assignToReference>UpdateCounter</assignToReference>
            <operator>Assign</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_Upsell_OLI</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_counter</name>
        <label>Update counter</label>
        <locationX>1287</locationX>
        <locationY>1780</locationY>
        <assignmentItems>
            <assignToReference>UpdateCounter</assignToReference>
            <operator>Add</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_Renewal_Products</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Check_products</name>
        <label>Check products</label>
        <locationX>1560</locationX>
        <locationY>1621</locationY>
        <defaultConnector>
            <targetReference>Loop_Renewal_Products</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Product_match</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_Upsell_OLI.PricebookEntryId</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>Loop_Renewal_Products.PricebookEntryId</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>UpdateCounter</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Loop_Upsell_OLI.UnitPrice</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>Loop_Renewal_Products.UnitPrice</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Loop_Upsell_OLI.Discount</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>OrderProductDiscountPercentNum</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Loop_Upsell_OLI.Part_of_a_package__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>Loop_Renewal_Products.Part_of_a_package__c</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Quantity_zero</targetReference>
            </connector>
            <label>Product match</label>
        </rules>
    </decisions>
    <decisions>
        <description>Evaluates whether an order has already been generated from the opportunity.

If an order has already been generated from the opportunity, a new order will not be generated.</description>
        <name>OrderGenerated</name>
        <label>Sales Order Generated?</label>
        <locationX>357</locationX>
        <locationY>531</locationY>
        <defaultConnector>
            <targetReference>Get_Account_Fields</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Order Not Generated</defaultConnectorLabel>
        <rules>
            <name>Order_Generated</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>oOppty.Sales_Order_Generated__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <label>Sales Order Generated</label>
        </rules>
    </decisions>
    <decisions>
        <name>Products_to_delete</name>
        <label>Products to delete?</label>
        <locationX>767</locationX>
        <locationY>2058</locationY>
        <defaultConnector>
            <targetReference>Products_to_update</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>listPreOrderProductToDelete</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Delete_products</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Products_to_update</name>
        <label>Products to update?</label>
        <locationX>766</locationX>
        <locationY>2226</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes_products_to_update</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>listPreOrderProductsToUpdate</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_products</targetReference>
            </connector>
            <label>Yes, products to update</label>
        </rules>
    </decisions>
    <decisions>
        <name>Products_updated</name>
        <label>Products updated?</label>
        <locationX>1155</locationX>
        <locationY>1951</locationY>
        <defaultConnector>
            <targetReference>Blank_update_counter</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>No_products_updated</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>UpdateCounter</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Pre_Order_Product</targetReference>
            </connector>
            <label>No products updated</label>
        </rules>
    </decisions>
    <decisions>
        <name>Quantity_zero</name>
        <label>Quantity zero?</label>
        <locationX>1561</locationX>
        <locationY>1790</locationY>
        <defaultConnector>
            <targetReference>Assign_new_Qtity</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Zero</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>NewQuantity</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Add_to_list_to_delete</targetReference>
            </connector>
            <label>Zero</label>
        </rules>
    </decisions>
    <description>BODEV-2684: Updated to include Part of package? field into the fields copied from Opp as well as order product matching criteria. Also, updated Product Match Criteria in case Discount__c field is null on the order products.</description>
    <environments>Default</environments>
    <formulas>
        <name>contractStartDatePlusYear</name>
        <dataType>Date</dataType>
        <expression>DATE( Year({!oOppty.Startdate_contract__c})+floor((MONTH({!oOppty.Startdate_contract__c}) + 11) / 12) , 
    mod(MONTH({!oOppty.Startdate_contract__c}) + 11, 12) + 1 , 
     day({!oOppty.Startdate_contract__c})
) - 1</expression>
    </formulas>
    <formulas>
        <description>Description of an order</description>
        <name>Description</name>
        <dataType>String</dataType>
        <expression>&quot;Pre-order&quot;</expression>
    </formulas>
    <formulas>
        <name>NewQuantity</name>
        <dataType>Number</dataType>
        <expression>{!Loop_Upsell_OLI.Quantity} + {!Loop_Renewal_Products.Quantity}</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <description>BODEV-2684: Formula to map Null value in Order Product Discount__c field to 0 so that Product Match Criteria works as intended.</description>
        <name>OrderProductDiscountPercentNum</name>
        <dataType>Number</dataType>
        <expression>IF(
  ISBLANK({!Loop_Renewal_Products.Discount__c}),
  0,
  {!Loop_Renewal_Products.Discount__c}
)</expression>
        <scale>8</scale>
    </formulas>
    <formulas>
        <name>RecordTypeID</name>
        <dataType>String</dataType>
        <expression>{!$Label.Pre_Order_Record_Type}</expression>
    </formulas>
    <interviewLabel>Create Pre-Order {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Create Pre-Order</label>
    <loops>
        <description>Iterates through each opportunity product in the sObject collection variable.</description>
        <name>Loop_MRR_Oppty_Products</name>
        <label>Loop Oppty Products</label>
        <locationX>330</locationX>
        <locationY>1695</locationY>
        <assignNextValueToReference>oMRROpptyProduct</assignNextValueToReference>
        <collectionReference>listOpptyProducts</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Assign_Order_Product_Fields</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Create_Order_Products</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <description>Loop over renewal products</description>
        <name>Loop_Renewal_Products</name>
        <label>Loop Renewal Products</label>
        <locationX>1280</locationX>
        <locationY>1608</locationY>
        <collectionReference>listOrderProductsCreated</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Check_products</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Products_updated</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <description>Loop over OLIs for each individual upsell</description>
        <name>Loop_Upsell_OLI</name>
        <label>Loop Upsell OLI</label>
        <locationX>1096</locationX>
        <locationY>1613</locationY>
        <collectionReference>listUpsellProducts</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Loop_Renewal_Products</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Loop_Upsells</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Loop_Upsells</name>
        <label>Loop Upsells</label>
        <locationX>780</locationX>
        <locationY>1719</locationY>
        <collectionReference>oUpsells</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Get_Upsell_OLIs</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Create_New_products</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordCreates>
        <name>Create_New_products</name>
        <label>Create New products</label>
        <locationX>780</locationX>
        <locationY>1896</locationY>
        <connector>
            <targetReference>Products_to_delete</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Order_product_error_screen</targetReference>
        </faultConnector>
        <inputReference>listOrderProductsToCreate</inputReference>
    </recordCreates>
    <recordCreates>
        <description>Uses the field values that are stored in the sObject variable to create an order.</description>
        <name>Create_Order</name>
        <label>Create Order</label>
        <locationX>328</locationX>
        <locationY>1533</locationY>
        <connector>
            <targetReference>Loop_MRR_Oppty_Products</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Order_error_screen</targetReference>
        </faultConnector>
        <inputReference>oOrder</inputReference>
    </recordCreates>
    <recordCreates>
        <name>Create_Order_Products</name>
        <label>Create Order Products</label>
        <locationX>505</locationX>
        <locationY>1721</locationY>
        <connector>
            <targetReference>Get_Created_Pre_order_products</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Order_product_error_screen</targetReference>
        </faultConnector>
        <inputReference>listPreOrderProducts</inputReference>
    </recordCreates>
    <recordDeletes>
        <name>Delete_products</name>
        <label>Delete products</label>
        <locationX>619</locationX>
        <locationY>2079</locationY>
        <connector>
            <targetReference>Products_to_update</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Order_product_error_screen_0</targetReference>
        </faultConnector>
        <inputReference>listPreOrderProductToDelete</inputReference>
    </recordDeletes>
    <recordLookups>
        <description>Queries the account on the opportunity, and stores selected account fields in an sObject variable.

ACTION: Review the retrieved account fields, and add any additional fields that you need to the sObject variable.</description>
        <name>Get_Account_Fields</name>
        <label>Get Account Fields</label>
        <locationX>345</locationX>
        <locationY>765</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_MRR_Oppty_Products</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oOppty.AccountId</elementReference>
            </value>
        </filters>
        <object>Account</object>
        <outputReference>oAccount</outputReference>
        <queriedFields>Original_Contract_Start_Date__c</queriedFields>
        <queriedFields>Platform__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>Get_Created_Pre_order_products</name>
        <label>Get Created Pre-order products</label>
        <locationX>633</locationX>
        <locationY>1703</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_Upsells</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OrderId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oOrder.Id</elementReference>
            </value>
        </filters>
        <object>OrderItem</object>
        <outputReference>listOrderProductsCreated</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>OrderId</queriedFields>
        <queriedFields>Discount__c</queriedFields>
        <queriedFields>Quantity</queriedFields>
        <queriedFields>TotalPrice</queriedFields>
        <queriedFields>Total_Price__c</queriedFields>
        <queriedFields>Netsuite_Quantity__c</queriedFields>
        <queriedFields>AvailableQuantity</queriedFields>
        <queriedFields>PricebookEntryId</queriedFields>
        <queriedFields>UnitPrice</queriedFields>
        <queriedFields>Part_of_a_package__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Looks up the opportunity products that are related to the opportunity, and stores selected field values in the sObject collection variable.

ACTION: Review the retrieved opportunity product fields, and add additional fields as needed to the sObject collection variable.</description>
        <name>Get_MRR_Oppty_Products</name>
        <label>Get MRR Oppty Products</label>
        <locationX>336</locationX>
        <locationY>908</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_upsells</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OpportunityId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oOppty.Id</elementReference>
            </value>
        </filters>
        <object>OpportunityLineItem</object>
        <outputReference>listOpptyProducts</outputReference>
        <queriedFields>Quantity</queriedFields>
        <queriedFields>TotalPrice</queriedFields>
        <queriedFields>PricebookEntryId</queriedFields>
        <queriedFields>Discount</queriedFields>
        <queriedFields>UnitPrice</queriedFields>
        <queriedFields>Part_of_a_package__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Uses the Opportunity ID passed to the flow to look up the opportunity, and stores the selected opportunity fields in an sObject variable.

ACTION: Review the retrieved opportunity fields, and add any additional fields that you need to the sObject variable.</description>
        <name>Get_Opportunity_Fields</name>
        <label>Get Opportunity Fields</label>
        <locationX>421</locationX>
        <locationY>394</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>OrderGenerated</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>OpptyID</elementReference>
            </value>
        </filters>
        <object>Opportunity</object>
        <outputReference>oOppty</outputReference>
        <queriedFields>AccountId</queriedFields>
        <queriedFields>Pricebook2Id</queriedFields>
        <queriedFields>CloseDate</queriedFields>
        <queriedFields>StageName</queriedFields>
        <queriedFields>current_user__c</queriedFields>
        <queriedFields>Invoice_period__c</queriedFields>
        <queriedFields>Startdate_contract__c</queriedFields>
        <queriedFields>Type</queriedFields>
        <queriedFields>MRR__c</queriedFields>
        <queriedFields>CurrencyIsoCode</queriedFields>
        <queriedFields>of_products_One_Off_Items__c</queriedFields>
        <queriedFields>PO_Number__c</queriedFields>
        <queriedFields>End_date_contract__c</queriedFields>
        <queriedFields>of_products_MRR__c</queriedFields>
        <queriedFields>Related_Renewal_Opportunity__c</queriedFields>
        <queriedFields>Opportunity_ID_18_digits__c</queriedFields>
        <queriedFields>Total_Contract_Value__c</queriedFields>
        <queriedFields>Products_being_merged__c</queriedFields>
        <queriedFields>Sales_Order_Generated__c</queriedFields>
        <queriedFields>Loss_Reason_Detail__c</queriedFields>
        <queriedFields>Netsuite_Term__c</queriedFields>
        <queriedFields>Account_ID_18_digits__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>Get_Upsell_OLIs</name>
        <label>Get Upsell OLIs</label>
        <locationX>777</locationX>
        <locationY>1598</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_Upsell_OLI</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OpportunityId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Loop_Upsells.Id</elementReference>
            </value>
        </filters>
        <object>OpportunityLineItem</object>
        <outputReference>listUpsellProducts</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>PricebookEntryId</queriedFields>
        <queriedFields>UnitPrice</queriedFields>
        <queriedFields>Quantity</queriedFields>
        <queriedFields>Discount</queriedFields>
        <queriedFields>TotalPrice</queriedFields>
        <queriedFields>Description</queriedFields>
        <queriedFields>OpportunityId</queriedFields>
        <queriedFields>Part_of_a_package__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Get values from all upsells on the account that has the same start and end date as the renewal opportunity. Stores only ID of such upsells.</description>
        <name>Get_upsells</name>
        <label>Get upsells</label>
        <locationX>336</locationX>
        <locationY>1058</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_Order_Fields</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Account_ID_18_digits__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oOppty.Account_ID_18_digits__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>End_date_contract__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oOppty.End_date_contract__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>IsClosed</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Startdate_contract__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>oOppty.Startdate_contract__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Type</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Existing Business-Upsell</stringValue>
            </value>
        </filters>
        <filters>
            <field>Id</field>
            <operator>NotEqualTo</operator>
            <value>
                <elementReference>oOppty.Id</elementReference>
            </value>
        </filters>
        <object>Opportunity</object>
        <outputReference>oUpsells</outputReference>
        <queriedFields>Id</queriedFields>
    </recordLookups>
    <recordUpdates>
        <name>Update_products</name>
        <label>Update products</label>
        <locationX>947</locationX>
        <locationY>2184</locationY>
        <faultConnector>
            <targetReference>Order_product_error_screen</targetReference>
        </faultConnector>
        <inputReference>listPreOrderProductsToUpdate</inputReference>
    </recordUpdates>
    <screens>
        <name>Order_error_screen</name>
        <label>Order error screen</label>
        <locationX>50</locationX>
        <locationY>1822</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>ErrorMessage</name>
            <fieldText>&lt;p&gt;An error occurred while creating the order. Please correct the issues and try again.&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Error Message:&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(211, 20, 20);&quot;&gt;{!$Flow.FaultMessage}&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Order_product_error_screen</name>
        <label>Order product error screen</label>
        <locationX>516</locationX>
        <locationY>1975</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>ErrorMessage_0</name>
            <fieldText>&lt;p&gt;An error occurred while creating or updating the order product. Please correct the issues and try again.&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Error Message:&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(211, 20, 20);&quot;&gt;{!$Flow.FaultMessage}&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Order_product_error_screen_0</name>
        <label>Order product error screen</label>
        <locationX>382</locationX>
        <locationY>2129</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>ErrorMessage_0_0</name>
            <fieldText>&lt;p&gt;An error occurred while deleting the order product. Please correct the issues and try again.&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Error Message:&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(211, 20, 20);&quot;&gt;{!$Flow.FaultMessage}&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>421</locationX>
        <locationY>216</locationY>
        <connector>
            <targetReference>Get_Opportunity_Fields</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <description>List of products from the renewal opportunity.</description>
        <name>listOpptyProducts</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OpportunityLineItem</objectType>
    </variables>
    <variables>
        <description>Contains all created pre-order products before merging in upsell products.</description>
        <name>listOrderProductsCreated</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <name>listOrderProductsToCreate</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <description>List of created pre-order products.</description>
        <name>listPreOrderProducts</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <description>List of pre-order products with updated quantity after merging related upsells.</description>
        <name>listPreOrderProductsToUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <description>List of pre-order products that have to be deleted after merging relevant upsells.</description>
        <name>listPreOrderProductToDelete</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <name>listUpsellProducts</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>OpportunityLineItem</objectType>
    </variables>
    <variables>
        <name>oAccount</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>Account</objectType>
    </variables>
    <variables>
        <name>oMRROpptyProduct</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OpportunityLineItem</objectType>
    </variables>
    <variables>
        <name>oMRROrderProduct</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <name>oOppty</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>oOrder</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Order</objectType>
    </variables>
    <variables>
        <name>OpptyID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>orPreOrderProduct</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <name>oUpsells</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>UpdateCounter</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
</Flow>
